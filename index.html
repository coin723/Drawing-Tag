<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
		<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<link type="text/css" rel="stylesheet" href="CSS/stylesheet.css" />
	</head>
	<body>
		<script>
			d3.csv("drawing-tag.csv", function(data) {
				//Define basic variables
				var margin = {top: 50, right: 50, bottom: 50, left: 50};
				var width = window.innerWidth - margin.right - margin.left;
				var height = width * 3 / 4 - margin.top - margin.bottom;

				//Draw canvas
				var svg = d3.select("body")
					.append("svg")
					.attr("id", "container")
					.attr("width", width + margin.right + margin.left)
					.attr("height", height + margin.top + margin.bottom);

				//Convert drawing codes into numbers
				data.forEach(function(d) {
					d.drawing_code = +d.drawing_code;
				});

				//Create nested maps
				var map_drawing_op = d3.nest()
					.key(function(d) {
						return d.drawing_code;
					});

				var nest_tag = d3.nest()
					.key(function(d) {
						return d.tag;
					});

				var map_tag = nest_tag.map(data, d3.map);

				var map_degree = nest_tag.rollup(function(leaves) {
						return leaves.length;
					})
					.map(data, d3.map);

				//Define scale
				var r_min = 5;
				var r_max = 20;
				var array_degree = [];
				map_degree.forEach(function(key, value) {
					array_degree.push(value);
				});

				var rScale = d3.scale.sqrt()
					.domain(d3.extent(array_degree))
					.range([r_min, r_max]);

				//Make nodes data
				var half_of_number = Math.round(d3.max(data, function(d) { return d.drawing_code; }) / 2);
				var cy_drawing = margin.top + 150;
				var h_int = Math.round((width - margin.left - margin.right) / (half_of_number - 1));

				var nodes_drawing = map_drawing_op.rollup(function(leaves) {
						var leaf = leaves[0];
						var cx, cy;

						leaf.drawing_code > half_of_number ? (
							cx = margin.left + (leaf.drawing_code - 1 - half_of_number) * h_int, cy = height - cy_drawing
							) : (
							cx = margin.left + (leaf.drawing_code - 1) * h_int, cy = cy_drawing
							);
						
						return {
							"cx": cx,
							"cy": cy
						};
					})
					.map(data, d3.map);

				var tags_width = width - margin.left - margin.right;
				var tags = {
					"x0": margin.left,
					"x1": margin.left + Math.round(tags_width / 3),
					"x2": margin.left + Math.round(tags_width * 2 / 3),
					"x3": margin.left + tags_width,
					"y0": cy_drawing + 20,
					"y1": height - cy_drawing - 20
				};

				var nodes_tag = nest_tag.rollup(function(leaves) {
						var leaf = leaves[0];
						var cx, cy, r;

						cy = tags.y0 + (tags.y1 - tags.y0) * Math.random();

						switch(leaf.tag_type) {
							case "기술":
								cx = tags.x0 + (tags.x1 - tags.x0) * Math.random();
								break;
							case "분석":
								cx = tags.x1 + (tags.x2 - tags.x1) * Math.random();
								break;
							case "해석":
								cx = tags.x2 + (tags.x3 - tags.x2) * Math.random();
								break;
							default:
								cx = tags.x0 + (tags.x3 - tags.x0) * Math.random();
						}

						r = rScale(map_degree.get(leaf.tag));
					});

				//Make link data
				var nodes_link;

				//Append drawing and tag groups
				var drawing_g = svg.selectAll(".drawing")
					.data(nodes_drawing)
					.enter()
					.append("g")
					.attr("class", function(d) {
						return "drawing drawing_code_" + d.drawing_code;
					});

				var tag_g = svg.selectAll(".tag")
					.data(nodes_tag)
					.enter()
					.append("g")
					.attr("class", function(d) {
						return "tag tag_code_" + d.tag_code;
					});

				//Append drawing nodes and text
				var r_basic = 10;
				drawing_g.append("circle")
					.attr("class", "node drawing")
					.attr("cx", function(d){
						return;
					})
					.attr("cy", function(d) {
						return;
					})
					.attr("r", r_basic);
				drawing_g.append("text")
					.attr("class", "name drawing")
					.text(function(d) {
						return d.name_drawing;
					});

				//Append tag nodes
				tag_g.append("circle")
					.attr("class", "node tag")
					.attr("cx", function(d) {
						return;
					})
					.attr("cy", function(d) {
						return;
					})
					.attr("r", function(d) {
						return rScale(d.degree);
					});
				tag_g.append("text")
					.attr("class", "name tag")
					.text(function(d) {
						return d.name_tag;
					});

				// //Append links
				// svg.selectAll(".link")
				// 	.data(nodes_link)
				// 	.enter()
				// 	.append("line")
				// 	.attr("class", "link")
				// 	.attr("x1", )
			});
		</script>
	</body>
</html>